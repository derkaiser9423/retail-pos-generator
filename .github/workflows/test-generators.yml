name: Test Data Generators

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: ðŸ§ª Test all generators
      run: python master_runner.py
      continue-on-error: true
    
    - name: âœ… Validate database schema
      run: |
        if [ -f validate_database.py ]; then
          python validate_database.py
        fi
      continue-on-error: true
    
    - name: ðŸ“Š Show test results
      run: |
        python -c "
        from utils import count_records
        tables = ['CATEGORY', 'SUPPLIER', 'STAFF', 'MACHINE', 'PAYMENT_METHOD', 
                  'TRANSACTION_TYPE', 'PRODUCT_GROUP', 'PRODUCT', 
                  'TRANSACTION_HEADER', 'TRANSACTION_LINE']
        print('=' * 40)
        print('TEST RESULTS')
        print('=' * 40)
        passed = 0
        failed = 0
        for table in tables:
            try:
                count = count_records(table)
                print(f'âœ“ {table:25} {count:>6} records')
                passed += 1
            except Exception as e:
                print(f'âœ— {table:25} ERROR')
                failed += 1
        print('=' * 40)
        print(f'Passed: {passed}/{len(tables)}')
        if failed == 0:
            print('âœ“ ALL TESTS PASSED')
        print('=' * 40)
        "
