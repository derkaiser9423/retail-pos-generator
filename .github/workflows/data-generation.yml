name: Automated Data Generation

on:
  schedule:
    # Run every 2 hours
    - cron: '0 */2 * * *'
  
  workflow_dispatch:  # Allow manual trigger
  
  push:
    branches: [ main, master ]
    paths:
      - '**.py'
      - '.github/workflows/**'

jobs:
  generate-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Full history for proper commits
    
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: ğŸ—„ï¸ Check database exists
      run: |
        if [ ! -f retail_pos.db ]; then
          echo "Database not found, will be created on first run"
        else
          echo "âœ“ Database found"
          ls -lh retail_pos.db
        fi
    
    - name: ğŸ“Š Generate Categories
      run: python wrapper_with_git.py 01_generate_categories.py
      continue-on-error: true
    
    - name: ğŸ¢ Generate Suppliers
      run: python wrapper_with_git.py 02_generate_suppliers.py
      continue-on-error: true
    
    - name: ğŸ‘¥ Generate Staff
      run: python wrapper_with_git.py 03_generate_staff.py
      continue-on-error: true
    
    - name: ğŸ–¥ï¸ Generate Machines
      run: python wrapper_with_git.py 04_generate_machines.py
      continue-on-error: true
    
    - name: ğŸ’³ Generate Payment Methods
      run: python wrapper_with_git.py 05_generate_payment_methods.py
      continue-on-error: true
    
    - name: ğŸ“‹ Generate Transaction Types
      run: python wrapper_with_git.py 06_generate_transaction_types.py
      continue-on-error: true
    
    - name: ğŸ·ï¸ Generate Product Groups
      run: python wrapper_with_git.py 07_generate_product_groups.py
      continue-on-error: true
    
    - name: ğŸ“¦ Generate Products
      run: python wrapper_with_git.py 08_generate_products.py
      continue-on-error: true
    
    - name: ğŸ§¾ Generate Transaction Headers
      run: python wrapper_with_git.py 09_generate_transaction_headers.py
      continue-on-error: true
    
    - name: ğŸ“ Generate Transaction Lines
      run: python wrapper_with_git.py 10_generate_transaction_lines.py
      continue-on-error: true
    
    - name: ğŸ“ˆ Generate Statistics Report
      run: python generate_stats_badge.py
    
    - name: ğŸ“¤ Commit and Push Changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add .
        git diff --staged --quiet || git commit -m "ğŸ¤– Automated data generation $(date +'%Y-%m-%d %H:%M:%S UTC')
        
        Generated by GitHub Actions
        Workflow: ${{ github.workflow }}
        Run: ${{ github.run_number }}"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ“Š Upload Database Artifact
      uses: actions/upload-artifact@v3
      with:
        name: retail-pos-database
        path: retail_pos.db
        retention-days: 30
    
    - name: ğŸ“‹ Upload Logs
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: generation-logs
        path: logs/*.log
        retention-days: 7